<?xml version="1.0" encoding="utf-8" ?>
<Wix
    xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
>
    <Product
        Id="7D2829F2-D524-4DDF-B3A1-08AAD508656A"
        Name="RLBot v5"
        Language="1033"
        Version="1.0.0"
        Manufacturer="RLBot Contributors"
        UpgradeCode="C5D56FDA-855A-4723-A1C8-6F37717593C4"
    >
        <Package
            Id="*"
            Keywords="Installer"
            Description="Installer for the RLBot v5 launcher"
            Manufacturer="RLBot Contributors"
            InstallerVersion="100"
            Languages="1033"
            Compressed="yes"
            InstallScope="perUser"
            SummaryCodepage="1252"
        />

        <Media Id="1" Cabinet="rlbot5.cab" EmbedCab="yes" />

        <MajorUpgrade
            DowngradeErrorMessage="A newer version of [ProductName] is already installed."
            Schedule="afterInstallInitialize"
        />

        <UIRef Id="WixUI_FeatureTree" />
        <UI>
            <Publish
                Dialog="WelcomeDlg"
                Control="Next"
                Event="NewDialog"
                Value="CustomizeDlg"
                Order="3"
            >1</Publish>
            <Publish
                Dialog="CustomizeDlg"
                Control="Back"
                Event="NewDialog"
                Value="WelcomeDlg"
                Order="3"
            >1</Publish>
            <Publish
                Dialog="ExitDialog"
                Control="Finish"
                Event="DoAction"
                Value="SetLaunchTarget"
            >WIXUI_EXITDIALOGOPTIONALCHECKBOX = "1"</Publish>
            <Publish
                Dialog="ExitDialog"
                Control="Finish"
                Event="DoAction"
                Value="LaunchApplication"
            >WIXUI_EXITDIALOGOPTIONALCHECKBOX = "1"</Publish>
        </UI>

        <Property Id="ARPPRODUCTICON" Value="AppIcon" />

        <Property
            Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT"
            Value="Start RLBot v5 Launcher"
        />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />

        <Icon Id="AppIcon" SourceFile="../assets/icon.ico" />

        <Property Id="INSTALL_PATH_REGISTRY">
            <RegistrySearch
                Id="GetInstallPath"
                Root="HKCU"
                Key="Software\RLBot5"
                Name="InstallPath"
                Type="raw"
            />
        </Property>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="LocalAppDataFolder">
                <Directory Id="INSTALLFOLDER" Name="RLBot5">

                    <Directory Id="BIN" Name="bin">
                        <Component Id="LauncherComponent" Guid="*">
                            <File
                                Id="LauncherFile"
                                Source="../target/x86_64-pc-windows-msvc/release/launcher.exe"
                                KeyPath="yes"
                            />
                            <CreateFolder />
                        </Component>
                    </Directory>

                    <Component Id="InstallFolderMarker" Guid="*">
                        <RegistryValue
                            Root="HKCU"
                            Key="Software\RLBot5"
                            Name="Installed"
                            Type="string"
                            Value="1"
                            KeyPath="yes"
                        />
                        <RegistryValue
                            Root="HKCU"
                            Key="Software\RLBot5"
                            Name="InstallPath"
                            Type="string"
                            Value="[INSTALLFOLDER]"
                        />
                        <CreateFolder />
                        <util:RemoveFolderEx
                            On="uninstall"
                            Property="INSTALL_PATH_REGISTRY"
                        />
                    </Component>
                </Directory>
            </Directory>

            <Directory Id="ProgramMenuFolder">
                <Directory Id="ProgramMenuDir" Name="RLBot5" />
            </Directory>
            <Directory Id="DesktopFolder" Name="Desktop" />
        </Directory>

        <DirectoryRef Id="ProgramMenuDir">
            <Component Id="StartMenuShortcutComponent" Guid="*">
                <Shortcut
                    Id="StartMenuShortcut"
                    Directory="ProgramMenuDir"
                    Name="RLBot v5 Launcher"
                    Target="[INSTALLFOLDER]bin\launcher.exe"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="AppIcon"
                />
                <RegistryValue
                    Root="HKCU"
                    Key="Software\RLBot5\Shortcuts"
                    Name="StartMenu"
                    Type="string"
                    Value="1"
                    KeyPath="yes"
                />
                <CreateFolder />
                <RemoveFolder
                    Id="RemoveStartMenuDir"
                    Directory="ProgramMenuDir"
                    On="uninstall"
                />
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="DesktopFolder">
            <Component Id="DesktopShortcutComponent" Guid="*">
                <Shortcut
                    Id="DesktopShortcut"
                    Directory="DesktopFolder"
                    Name="RLBot v5 Launcher"
                    Target="[INSTALLFOLDER]bin\launcher.exe"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="AppIcon"
                />
                <RegistryValue
                    Root="HKCU"
                    Key="Software\RLBot5\Shortcuts"
                    Name="Desktop"
                    Type="string"
                    Value="1"
                    KeyPath="yes"
                />
                <CreateFolder />
            </Component>
        </DirectoryRef>

        <Feature
            Id="ProductFeature"
            Title="RLBot v5"
            Level="1"
            Display="hidden"
        >
            <ComponentRef Id="LauncherComponent" />
            <ComponentRef Id="InstallFolderMarker" />
        </Feature>

        <Feature
            Id="StartMenuFeature"
            Title="Start Menu Shortcut"
            Level="1"
            Display="expand"
        >
            <ComponentRef Id="StartMenuShortcutComponent" />
        </Feature>
        <Feature
            Id="DesktopFeature"
            Title="Desktop Shortcut"
            Level="1"
            Display="expand"
        >
            <ComponentRef Id="DesktopShortcutComponent" />
        </Feature>


        <CustomAction
            Id="SetLaunchTarget"
            Property="WixShellExecTarget"
            Value="[INSTALLFOLDER]bin\launcher.exe"
            Execute="immediate"
        />
        <CustomAction
            Id="LaunchApplication"
            BinaryKey="WixCA"
            DllEntry="WixShellExec"
            Execute="immediate"
            Return="ignore"
        />
    </Product>
</Wix>
